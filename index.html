<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>too-many-cells</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Gregory W. Schwartz" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">too-many-cells</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org5200fae">Description</a></li>
<li><a href="#orge743176">New features for v2.0.0.0</a></li>
<li><a href="#orgbffe2e8">New features since initial launch</a></li>
<li><a href="#orga013de0">Installation</a>
<ul>
<li><a href="#orga0d6c5f">nix</a></li>
<li><a href="#org6f9bf54">Stack (unsupported in <code>too-many-cells &gt;= v2.0.0.0</code>, use nix)</a>
<ul>
<li><a href="#org8a75a4b">Dependencies</a></li>
<li><a href="#org29b76c2">Install <code>stack</code></a></li>
<li><a href="#org5db7174">Install <code>too-many-cells</code></a></li>
</ul>
</li>
<li><a href="#org1e5c595">Docker</a></li>
</ul>
</li>
<li><a href="#org1bad0a3">Troubleshooting</a>
<ul>
<li><a href="#orgaf73ea5">Using nix, I'm getting shared object not found errors.</a></li>
<li><a href="#org960a0fd">I am getting errors like <code>AesonException "Error in $.packages.cassava.constraints.flags...</code> when running <code>stack</code> commands</a></li>
<li><a href="#org8bd39c6">I use conda or custom ld library locations and I cannot install <code>too-many-cells</code> or run into weird R errors</a></li>
<li><a href="#orgee07567">I am still having issues with installation</a></li>
<li><a href="#orgb636939">I am on macOS/Windows with docker and <code>too-many-cells</code> silently crashes.</a></li>
</ul>
</li>
<li><a href="#org0d86bd4">Included projects</a></li>
<li><a href="#org8af80cb">Usage</a>
<ul>
<li><a href="#makeTreeUsage"><code>make-tree</code></a>
<ul>
<li><a href="#org67e6f13">Output</a></li>
<li><a href="#org775fa84">Outline with options</a></li>
<li><a href="#orgb76c444">Example</a></li>
</ul>
</li>
<li><a href="#orga140db3"><code>interactive</code></a></li>
<li><a href="#org2d5e26d"><code>differential</code></a></li>
<li><a href="#org713068b"><code>diversity</code></a></li>
<li><a href="#orgba6460a"><code>paths</code></a></li>
<li><a href="#too-many-peaks">Working with scATAC-seq data using <code>too-many-peaks</code></a></li>
<li><a href="#org41d285d"><code>peaks</code></a></li>
<li><a href="#org2f4d597"><code>motifs</code></a></li>
<li><a href="#orgee26d3b"><code>classify</code></a></li>
<li><a href="#org3465cbc"><code>matrix-output</code></a></li>
</ul>
</li>
<li><a href="#orged6ae7c">Advanced documentation</a></li>
<li><a href="#org2038869">Demo</a></li>
</ul>
</div>
</div>
<p>
<a href="https://gregoryschwartz.github.io/too-many-cells/">Website</a>
</p>

<p>
See <a href="https://github.com/GregorySchwartz/too-many-cells">https://github.com/GregorySchwartz/too-many-cells</a> for latest version. See <a href="#too-many-peaks">
<code>too-many-peaks</code> </a> for more information about scATAC-seq usage.
</p>

<p>
See <a href="https://doi.org/10.1038/s41592-020-0748-5">the publication</a> (and please cite!) for more information about the algorithm.
</p>


<div class="figure">
<p><img src="img/pruned_tree.png" alt="pruned_tree.png" />
</p>
</div>

<div id="outline-container-org5200fae" class="outline-2">
<h2 id="org5200fae">Description</h2>
<div class="outline-text-2" id="text-org5200fae">
<p>
<code>too-many-cells</code> is a suite of tools, algorithms, and visualizations focusing on
the relationships between cell clades. This includes new ways of clustering,
plotting, choosing differential expression comparisons, and more! While
<code>too-many-cells</code> was intended for single cell RNA-seq, any abundance data in any
domain can be used. Rather than opt for a unique positioning of each cell using
dimensionality reduction approaches like t-SNE, UMAP, and LSA, <code>too-many-cells</code>
recursively divides cells into clusters and relates clusters rather than
individual cells. In fact, by recursively dividing until further dividing would
be considered noise or random partitioning, we can eliminate noisy relationships
at the fine-grain level. The resulting binary tree serves as a basis for a
different perspective of single cells, using our <a href="http://github.com/GregorySchwartz/birch-beer#readme"> <code>birch-beer</code> </a> visualization
and tree measures to describe simultaneously large and small populations,
without additional parameters or runs. See below for a full list of features.
</p>
</div>
</div>


<div id="outline-container-orge743176" class="outline-2">
<h2 id="orge743176">New features for v2.0.0.0</h2>
<div class="outline-text-2" id="text-orge743176">
<ul class="org-ul">
<li>Support for scATAC-seq for chromatin state relationships with <a href="#too-many-peaks"> <code>too-many-peaks</code> </a>!</li>
<li>Find enchriched regions as peaks for scATAC-seq with <code>peaks</code>.</li>
<li>Find motifs from differential chromatin state using <code>motifs</code>.</li>
<li>Linear relationships across the tree as pseudotime with <code>paths</code>.</li>
<li>Classify single-cell data from bulk with <code>classify</code>.</li>
<li>New dimensionality reductions with <code>--lsa</code>.</li>
<li>Output transformed matrix with <code>matrix-output</code>.</li>
<li>Bypass <code>labels.csv</code> with <code>-Z</code> quick labels.</li>
<li>MADs-from-median-based thresholds for multi-gene overlay plots</li>
<li>Multiple normalization application</li>
<li>And much more!</li>
</ul>
</div>
</div>

<div id="outline-container-orgbffe2e8" class="outline-2">
<h2 id="orgbffe2e8">New features since initial launch</h2>
<div class="outline-text-2" id="text-orgbffe2e8">
<ul class="org-ul">
<li>Now packaged for the functional package manager <code>nix</code> (Linux only)! No more dependency
shuffling or root for Docker needed!</li>
<li>A new R wrapper was written to quickly get data to and from <code>too-many-cells</code>
from R. <a href="https://github.com/GregorySchwartz/tooManyCellsR">Check it out here</a>!</li>
<li>Now works with Cellranger 3.0 matrices in addition to Cellranger 2.0</li>
<li>Can prune (make into leaves) specified nodes with <code>--custom-cut</code>.</li>
<li>Can analyze sets of features averaged together (e.g. gene sets). <b>Breaks API</b>,
so update your <code>--draw-leaf "DrawItem (DrawContinuous \"Cd4\")"</code> argument to
<code>--draw-leaf "DrawItem (DrawContinuous [\"Cd4\"])"</code> (notice the list
notation).</li>
<li>Outputs values from differential entry point plots (from <code>--features</code>), and can
aggregate features by average.</li>
</ul>
</div>
</div>

<div id="outline-container-orga013de0" class="outline-2">
<h2 id="orga013de0">Installation</h2>
<div class="outline-text-2" id="text-orga013de0">
<p>
We provide multiple ways to install <code>too-many-cells</code>. We recommend installing
with <a href="#orga0d6c5f"> <code>nix</code> </a>. <code>nix</code> will provide all dependencies in the build, supports Linux,
and should be reproducible, so try that first. We also have <a href="#org1e5c595">docker</a> images and a
<code>Dockerfile</code> to use in any system in case you have a custom build (for instance,
a non-standard R installation) or difficulty installing. <b>macOS and Windows
users:</b> <code>too-many-cells</code> was built and tested on Linux, so we highly recommend
using the <a href="#org1e5c595">docker</a> image (which is a completely isolated environment which
requires no compiling or installation, other than docker itself) as there may be
difficulties in installing the dependencies.
</p>
</div>

<div id="outline-container-orga0d6c5f" class="outline-3">
<h3 id="orga0d6c5f">nix</h3>
<div class="outline-text-3" id="text-orga0d6c5f">
<p>
<code>too-many-cells</code> can be installed using the functional package manager <a href="https://nixos.org/nix/"> <code>nix</code> </a>.
While you will need <code>sudo</code> to install, no <code>sudo</code> is required after the correct
setup. First, install <code>nix</code> following the instructions
<a href="https://nixos.org/nix/">on the website</a>. Then, with an unset <code>LD_LIBRARY_PATH</code>,
</p>

<div class="org-src-container">
<pre class="src src-sh">git clone https://github.com/GregorySchwartz/too-many-cells.git
<span style="color: #ff8700;">cd</span> too-many-cells
nix-env -f default.nix -i too-many-cells
</pre>
</div>
</div>
</div>

<div id="outline-container-org6f9bf54" class="outline-3">
<h3 id="org6f9bf54">Stack (unsupported in <code>too-many-cells &gt;= v2.0.0.0</code>, use nix)</h3>
<div class="outline-text-3" id="text-org6f9bf54">
</div>
<div id="outline-container-org8a75a4b" class="outline-4">
<h4 id="org8a75a4b">Dependencies</h4>
<div class="outline-text-4" id="text-org8a75a4b">
<p>
You may require the following dependencies to build and run (from Ubuntu 14.04,
use the appropriate packages from your distribution of choice):
</p>

<ul class="org-ul">
<li>build-essential</li>
<li>libgmp-dev</li>
<li>libblas-dev</li>
<li>liblapack-dev</li>
<li>libgsl-dev</li>
<li>libgtk2.0-dev</li>
<li>libcairo2-dev</li>
<li>libpango1.0-dev</li>
<li>graphviz</li>
<li>r-base</li>
<li>r-base-dev</li>
</ul>

<p>
To install them, in Ubuntu:
</p>

<div class="org-src-container">
<pre class="src src-shell">sudo apt install build-essential libgmp-dev libblas-dev liblapack-dev libgsl-dev libgtk2.0-dev libcairo2-dev libpango1.0-dev graphviz r-base r-base-dev
</pre>
</div>

<p>
<code>too-many-cells</code> also uses the following packages from R:
</p>

<ul class="org-ul">
<li>cowplot</li>
<li>ggplot2</li>
<li>edgeR</li>
<li>jsonlite</li>
</ul>

<p>
To install them in R,
</p>

<div class="org-src-container">
<pre class="src src-R">install.packages<span style="color: #008787;">(</span>c<span style="color: #d75f87;">(</span><span style="color: #afaf00;">"ggplot2"</span>, <span style="color: #afaf00;">"cowplot"</span>, <span style="color: #afaf00;">"jsonlite"</span><span style="color: #d75f87;">)</span><span style="color: #008787;">)</span>
install.packages<span style="color: #008787;">(</span><span style="color: #afaf00;">"BiocManager"</span><span style="color: #008787;">)</span>
BiocManager::install<span style="color: #008787;">(</span><span style="color: #afaf00;">"edgeR"</span><span style="color: #008787;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org29b76c2" class="outline-4">
<h4 id="org29b76c2">Install <code>stack</code></h4>
<div class="outline-text-4" id="text-org29b76c2">
<p>
See <a href="https://docs.haskellstack.org/en/stable/README/">https://docs.haskellstack.org/en/stable/README/</a> for more details.
</p>

<div class="org-src-container">
<pre class="src src-sh">curl -sSL https://get.haskellstack.org/ | sh
stack setup
</pre>
</div>
</div>
</div>

<div id="outline-container-org5db7174" class="outline-4">
<h4 id="org5db7174">Install <code>too-many-cells</code></h4>
<div class="outline-text-4" id="text-org5db7174">
</div>
<ul class="org-ul">
<li><a id="org54c1e26"></a>Source<br />
<div class="outline-text-5" id="text-org54c1e26">
<p>
Probably the easiest method if you don't want to mess with dependencies (outside
of the ones above).
</p>

<div class="org-src-container">
<pre class="src src-sh">git clone https://github.com/GregorySchwartz/too-many-cells.git
<span style="color: #ff8700;">cd</span> too-many-cells
stack install
</pre>
</div>
</div>
</li>

<li><a id="org6c0c0a9"></a>Online<br />
<div class="outline-text-5" id="text-org6c0c0a9">
<p>
We only require <code>stack</code> (or <code>cabal</code>), you do not need to download any source
code (but you might need the stack.yaml.old dependency versions), just run the
following command to place <code>too-many-cells &lt; v2.0.0.0</code> in your <code>~/.local/bin/</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh">mv stack.yaml.preV2 stack.yaml
stack install too-many-cells
</pre>
</div>

<p>
If you run into errors like <code>Error: While constructing the build plan, the
following exceptions were encountered:</code>, then follow the advice. Usually you
just need to follow the suggestion and add the dependencies to the specified
file. For a quick <code>yaml</code> configuration, refer to
<a href="https://github.com/GregorySchwartz/too-many-cells/blob/master/stack.yaml.old">https://github.com/GregorySchwartz/too-many-cells/blob/master/stack.yaml.old</a>.
</p>
</div>
</li>

<li><a id="macOS"></a>macOS<br />
<div class="outline-text-5" id="text-macOS">
<p>
We recommend using <a href="#org1e5c595">docker</a> on macOS. The following is written for
<code>too-many-cells &lt; v2.0.0.0</code>. If you must compile
<code>too-many-cells</code>, you should get the above dependencies. For some dependencies,
you can use <a href="https://brew.sh/">brewer</a>, then install <code>too-many-cells</code> (in the cloned folder, don't
forget to install the R dependencies above):
</p>

<div class="org-src-container">
<pre class="src src-shell">brew cask install xquartz
brew install glib cairo gtk gettext fontconfig freetype

brew tap brewsci/bio
brew tap brewsci/science
brew install r zeromq graphviz pkg-config gsl libffi gobject-introspection gtk+ gtk+3

<span style="color: #767676;"># </span><span style="color: #767676;">Needed so pkg-config and libraries can be found.</span>
<span style="color: #767676;"># </span><span style="color: #767676;">For the second path, use the ouput of "brew info libffi".</span>
<span style="color: #ff8700;">export</span> <span style="color: #87afaf;">PKG_CONFIG_PATH</span>=/usr/local/lib/pkgconfig:/usr/local/opt/libffi/lib/pkgconfig

<span style="color: #767676;"># </span><span style="color: #767676;">Tell gtk that it's quartz</span>
stack install --flag gtk:have-quartz-gtk
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-org1e5c595" class="outline-3">
<h3 id="org1e5c595">Docker</h3>
<div class="outline-text-3" id="text-org1e5c595">
<p>
Different computers have different setups, operating systems, and repositories.
Do put the entire program in a container to bypass difficulties (with the other
methods above), we user <code>docker</code>. So first, <a href="https://docs.docker.com/">install docker</a>.
</p>

<p>
To get <code>too-many-cells</code> (replace 2.0.0.0 with <a href="https://cloud.docker.com/repository/docker/gregoryschwartz/too-many-cells/general">any version needed</a>):
</p>

<div class="org-src-container">
<pre class="src src-sh">docker pull gregoryschwartz/too-many-cells:2.0.0.0
</pre>
</div>

<p>
To run <code>too-many-cells</code> in a docker container:
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo docker run -it --rm -v <span style="color: #afaf00;">"/home/username:/home/username"</span> gregoryschwartz/too-many-cells:2.0.0.0 -h
</pre>
</div>

<p>
Now you can follow the tutorial below with the addition of the docker paths and
commands. If you add yourself to the docker group, <code>sudo</code> is not needed. For instance:
</p>

<div class="org-src-container">
<pre class="src src-sh">docker run -it --rm -v <span style="color: #afaf00;">"/home/username:/home/username"</span> <span style="color: #afaf00;">\</span>
    gregoryschwartz/too-many-cells:2.0.0.0 make-tree <span style="color: #afaf00;">\</span>
    --matrix-path /home/username/path/to/input <span style="color: #afaf00;">\</span>
    --labels-file /home/username/path/to/labels.csv <span style="color: #afaf00;">\</span>
    --draw-collection <span style="color: #afaf00;">"PieRing"</span> <span style="color: #afaf00;">\</span>
    --output /home/username/path/to/out <span style="color: #afaf00;">\</span>
    &gt; clusters.csv
</pre>
</div>

<p>
Make sure to <a href="https://docs.docker.com/config/containers/resource_constraints/">increase the memory</a> that can be used by docker containers if you
use macOS or Windows. Also, docker won't be able to find your files by default.
You need to mount the folders with <code>-v</code> in order to have docker read and write
from and to the filesystem, respectively. Read the <a href="https://docs.docker.com/storage/volumes/">documentation</a> about volumes
for more information. You can simply mount your entire relevant path as in the
above example to handle both input and output, or just mount your entire user
directory as above. Specifically, <code>-v "/home/username:/home/username"</code> for the
whole directory or each individual <code>-v /path/to/matrix/on/host:/input_matrix</code>
with <code>-m /input_matrix</code> is what you want, where before the <code>:</code> is on the host
filesystem while after the <code>:</code> is what the docker program sees. Then you can
write the output in the same way: <code>-v /path/to/output/on/host:/output</code> will
write the output to the folder before the <code>:</code>.
</p>

<p>
To build the <code>too-many-cells</code> image yourself if you want:
</p>

<div class="org-src-container">
<pre class="src src-sh">nix-build docker.nix
docker load &lt; /nix/store/$<span style="color: #008787;">{</span><span style="color: #87afaf;">NAME_OF_OUTPUT_IMAGE</span><span style="color: #008787;">}</span>.tar.gz
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1bad0a3" class="outline-2">
<h2 id="org1bad0a3">Troubleshooting</h2>
<div class="outline-text-2" id="text-org1bad0a3">
</div>
<div id="outline-container-orgaf73ea5" class="outline-3">
<h3 id="orgaf73ea5">Using nix, I'm getting shared object not found errors.</h3>
<div class="outline-text-3" id="text-orgaf73ea5">
<p>
Be sure to have <code>LD_LIBRARY_PATH</code> unset when running <code>nix-env</code> to make sure the
linked libraries are in <code>/nix/store</code>.
</p>
</div>
</div>

<div id="outline-container-org960a0fd" class="outline-3">
<h3 id="org960a0fd">I am getting errors like <code>AesonException "Error in $.packages.cassava.constraints.flags...</code> when running <code>stack</code> commands</h3>
<div class="outline-text-3" id="text-org960a0fd">
<p>
Try upgrading stack with <code>stack upgrade</code>. The new installation will be in
<code>~/.local/bin</code>, so use that binary.
</p>
</div>
</div>

<div id="outline-container-org8bd39c6" class="outline-3">
<h3 id="org8bd39c6">I use conda or custom ld library locations and I cannot install <code>too-many-cells</code> or run into weird R errors</h3>
<div class="outline-text-3" id="text-org8bd39c6">
<p>
<code>stack</code> and <code>too-many-cells</code> assume system libraries and programs. To solve this
issue, first install the dependencies above at the system level, including
system <code>R</code>. Then to every <code>stack</code> and <code>too-many-cells</code> command, prepend
<code>PATH="$HOME/.local/bin:/usr/bin:$PATH"</code> to all commands. For instance:
</p>

<ul class="org-ul">
<li><code>PATH="$HOME/.local/bin:/usr/bin:$PATH" stack install</code></li>
<li><code>PATH="$HOME/.local/bin:/usr/bin:$PATH" too-many-cells make-tree -h</code></li>
</ul>

<p>
If your shared libraries are abnormal and use <code>libR.so</code> from non-system
locations, be sure to also have <code>LD_LIBRARY_PATH=/usr/lib/:$LD_LIBRARY_PATH</code>
when installing (and / or the location of R libraries, such as
<code>/usr/local/lib/R/lib/</code>).
</p>
</div>
</div>

<div id="outline-container-orgee07567" class="outline-3">
<h3 id="orgee07567">I am still having issues with installation</h3>
<div class="outline-text-3" id="text-orgee07567">
<p>
<a href="https://github.com/GregorySchwartz/too-many-cells/issues">Open an issue</a>! While working on the issue, try out the docker for
<code>too-many-cells</code>, it requires no installation at all (other than docker).
</p>
</div>
</div>

<div id="outline-container-orgb636939" class="outline-3">
<h3 id="orgb636939">I am on macOS/Windows with docker and <code>too-many-cells</code> silently crashes.</h3>
<div class="outline-text-3" id="text-orgb636939">
<p>
Docker containers may run into this issue if the memory given to the containers
is insufficient. Make sure to <a href="https://docs.docker.com/config/containers/resource_constraints/">increase the memory</a> that can be used by docker
containers.
</p>
</div>
</div>
</div>

<div id="outline-container-org0d86bd4" class="outline-2">
<h2 id="org0d86bd4">Included projects</h2>
<div class="outline-text-2" id="text-org0d86bd4">
<p>
This project is a collection of libraries and programs written specifically for
<code>too-many-cells</code>:
</p>

<dl class="org-dl">
<dt><a href="https://github.com/GregorySchwartz/birch-beer"> <code>birch-beer</code> </a></dt><dd>Generate a tree for displaying a hierarchy of groups with
colors, scaling, and more.</dd>
<dt><a href="https://github.com/GregorySchwartz/modularity"> <code>modularity</code> </a></dt><dd>Find the modularity of a network.</dd>
<dt><a href="https://github.com/GregorySchwartz/spectral-clustering"> <code>spectral-clustering</code> </a></dt><dd>Library for spectral clustering.</dd>
<dt><a href="https://github.com/GregorySchwartz/hierarchical-spectral-clustering"> <code>hierarchical-spectral-clustering</code> </a></dt><dd>Hierarchical spectral clustering of a
graph.</dd>
<dt><a href="https://github.com/GregorySchwartz/differential"> <code>differential</code> </a></dt><dd>Finds out whether an entity comes from different
distributions (statuses).</dd>
</dl>
</div>
</div>

<div id="outline-container-org8af80cb" class="outline-2">
<h2 id="org8af80cb">Usage</h2>
<div class="outline-text-2" id="text-org8af80cb">
<p>
<code>too-many-cells</code> has several entry points depending on the desired analysis.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Argument</th>
<th scope="col" class="org-left">Analysis</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>make-tree</code></td>
<td class="org-left">Generate the tree from single cell data with various measurement outputs and visualize tree</td>
</tr>

<tr>
<td class="org-left"><code>interactive</code></td>
<td class="org-left">Interactive visuzalization of the tree, very slow</td>
</tr>

<tr>
<td class="org-left"><code>differential</code></td>
<td class="org-left">Find differentially expressed features between two nodes</td>
</tr>

<tr>
<td class="org-left"><code>diversity</code></td>
<td class="org-left">Conduct diversity analyses of multiple cell populations</td>
</tr>

<tr>
<td class="org-left"><code>paths</code></td>
<td class="org-left">The binary tree equivalent of the so called "pseudotime", or 1D dimensionality reduction</td>
</tr>
</tbody>
</table>

<p>
The main workflow is to first generate and plot the population tree using
<code>too-many-cells make-tree</code>, then use the rest of the entry points as needed.
</p>

<p>
At any point, use <code>-h</code> to see the help of each entry point.
</p>

<p>
Also, check out <a href="https://github.com/GregorySchwartz/tooManyCellsR">tooManyCellsR</a> for an R wrapper!
</p>
</div>

<div id="outline-container-orgf4d9c65" class="outline-3">
<h3 id="makeTreeUsage"><code>make-tree</code></h3>
<div class="outline-text-3" id="text-makeTreeUsage">
<p>
<code>too-many-cells make-tree</code> generates a binary tree using hierarchical spectral
clustering. We start with all cells in a single node. Spectral clustering
partitions the cells into two groups. We assess the clustering using
Newman-Girvan modularity: if \(Q > 0\) then we recursively continue with
hierarchical spectral clustering. If not, then there is only a single community
and we do not partition &#x2013; the resulting node is a leaf and is considered the
finest-grain cluster.
</p>

<p>
<b>The most important argument is the &#x2013;prior argument.</b> Making the tree may
take some time, so if the tree was already generated and other analysis or
visualizations need to be run on the tree, point the <code>--prior</code> argument to the
output folder from a previous run of <code>too-many-cells</code>. If you do not use
<code>--prior</code>, <b>the entire tree will be recalculated even if you just wanted to
change the visualization!</b>
</p>

<p>
The main input is the <code>--matrix-path</code> argument. When a directory is supplied,
<code>too-many-cells</code> interprets the folder to have <code>matrix.mtx</code>, <code>genes.tsv</code>, and
<code>barcodes.tsv</code> files (<code>cellranger</code> outputs, see <code>cellranger</code> for specifics). If
a file is supplied instead of a directory, we assume a <code>csv</code> file containing
feature row names and cell column names. This argument can be called multiple times
to combine multiple single cell matrices: <code>--matrix-path input1 --matrix-path
input2</code>.
</p>

<p>
The second most important argument is <code>--labels-file</code>. Supply with a <code>csv</code> with
a format and header of "item,label" to provide colorings and statistics of the
relationships between labels. Here the "item" column contains the name of each
cell (barcode) and the label is any property of the cell (the tissue of origin,
hour in a time course, celltype, etc.). You can also now use <code>-Z</code> as a list for
each matching <code>-m</code> in order to manually give the entire matrix that label
(useful for situations like <code>-m ./t-all -Z T-ALL -m ./control -Z Control). To
get the newly generated labels with =-Z</code> into a <code>labels.csv</code> file, specify
<code>--labels-output</code> and the <code>labels.csv</code> will be in the output folder.
</p>

<p>
To see the full list of options, use <code>too-many-cells -h</code> and <code>-h</code> for each entry
point (i.e. <code>too-many-cells make-tree -h</code>).
</p>
</div>

<div id="outline-container-org67e6f13" class="outline-4">
<h4 id="org67e6f13">Output</h4>
<div class="outline-text-4" id="text-org67e6f13">
<p>
<code>too-many-cells make-tree</code> generates several files in the output folder. Below
is a short description of each file.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">File</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>clumpiness.csv</code></td>
<td class="org-left">When labels are provided, uses the clumpiness measure to determine the level of aggregation between each label within the tree.</td>
</tr>

<tr>
<td class="org-left"><code>clumpiness.pdf</code></td>
<td class="org-left">When labels are provided, a figure of the clumpiness between labels.</td>
</tr>

<tr>
<td class="org-left"><code>cluster_diversity.csv</code></td>
<td class="org-left">When labels are provided, the diversity, or "effective number of labels", of each cluster.</td>
</tr>

<tr>
<td class="org-left"><code>cluster_info.csv</code></td>
<td class="org-left">Various bits of information for each cluster and the path leading up to each cluster, from that cluster to the root. For instance, the <code>size</code> column has <code>cluster_size/parent_size/parent_parent_size/.../root_size</code></td>
</tr>

<tr>
<td class="org-left"><code>cluster_list.json</code></td>
<td class="org-left">The <code>json</code> file containing a list of clusterings.</td>
</tr>

<tr>
<td class="org-left"><code>cluster_tree.json</code></td>
<td class="org-left">The <code>json</code> file containing the output tree in a recursive format.</td>
</tr>

<tr>
<td class="org-left"><code>dendrogram.svg</code></td>
<td class="org-left">The visualization of the tree. There are many possible options for this visualization included. Can rename to choose between PNG, PS, PDF, and SVG using <code>--dendrogram-output</code>.</td>
</tr>

<tr>
<td class="org-left"><code>graph.dot</code></td>
<td class="org-left">A <code>dot</code> file of the tree, with less information than the tree in <code>cluster_results.json</code>.</td>
</tr>

<tr>
<td class="org-left"><code>node_info.csv</code></td>
<td class="org-left">Various information of each node in the tree.</td>
</tr>

<tr>
<td class="org-left"><code>projection.pdf</code></td>
<td class="org-left">When <code>--projection</code> is supplied with a file of the format "barcode,x,y", provides a plot of each cell at the specified x and y coordinates (for instance, when looking at t-SNE plots with the same labelings as the dendrogram here).</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org775fa84" class="outline-4">
<h4 id="org775fa84">Outline with options</h4>
<div class="outline-text-4" id="text-org775fa84">
<p>
The basic outline of the <b>default</b> matrix pre-processing pipeline with some
relevant options is as follows (there are many additional options including cell
whitelists that can be seen using <code>too-many-cells make-tree -h</code>):
</p>

<ol class="org-ol">
<li>Read matrix.</li>
<li>Optionally remove cells with less than X counts (<code>--filter-thresholds</code>).</li>
<li>Optionally remove features with less than X count (<code>--filter-thresholds</code>).</li>
<li>Term frequency-inverse document frequency normalization (<code>--normalization</code>).</li>
<li>Optionally use dimensionality reduction (<code>--lsa</code>).</li>
<li>Finish.</li>
</ol>
</div>
</div>

<div id="outline-container-orgb76c444" class="outline-4">
<h4 id="orgb76c444">Example</h4>
<div class="outline-text-4" id="text-orgb76c444">
</div>
<ul class="org-ul">
<li><a id="preprocessedData"></a>Setup<br />
<div class="outline-text-5" id="text-preprocessedData">
<p>
We start with our input matrix. Here,
</p>

<div class="org-src-container">
<pre class="src src-sh">ls ./input
</pre>
</div>

<pre class="example">
barcodes.tsv  genes.tsv  matrix.mtx
</pre>

<p>
Note that the input can be a directory (with the <code>cellranger</code> matrix format
above) or a file (a <code>csv</code> file). You can also point to a <code>cellranger</code> &gt;= 3.0
folder which has <code>matrix.mtx.gz</code>, <code>features.tsv.gz</code>, and <code>barcodes.tsv.gz</code> files
instead. <b>You don't need to use scRNA-seq data!</b> You can use any data that has
observations (cells) and features (genes), as long as you agree that the
observations are related by their feature abundances. If
you do upstream batch effect correction, LSA, normalization, or anything else,
be sure to use <code>--normalization NoneNorm</code> (and <code>--shift-positive</code>
for LSA) to avoid wrong filters and scalings! <b>If using dimensionality reduction
such as PCA and t-SNE</b>, we highly recommend generating your own similarity
matrix for use with our <code>cluster-tree</code> program and plot with <code>birch-beer</code>, as we
emphasize a feature matrix in <code>too-many-cells</code> and dimensionality reduction
algorithms transform counts (our input which works with cosine similarity) into
more nebulous information (which may not work with cosine similarity).
<code>cluster-tree</code>, however, can be used with adjacency and similarity matrices. As
for formats, the matrix market format contains three files like so:
</p>

<p>
The <code>matrix.mtx</code> file is in matrix market format.
</p>

<pre class="example">
%%MatrixMarket matrix coordinate integer general
%
23433 1981 4255069
4 1 1
5 1 1
11 1 2
23 1 2
25 1 2
40 1 2
48 1 1
...
</pre>

<p>
The <code>genes.tsv</code> file (or <code>features.tsv.gz</code>) contains the features of each cell
and corresponds to the rows of <code>matrix.mtx</code>. Here, both columns were the same
gene symbols, but you can have Ensembl as the first column and gene symbol as
the second, etc. The columns and column orders don't matter, but make sure all
matrices have the same format and specify the symbols you want to use (for
overlaying gene expression, differential expression, etc.) with
<code>--feature-column COLUMN</code>. So to use the second column for gene expression, you
would use <code>--feature-column 2</code>.
</p>

<pre class="example">
Xkr4	Xkr4
Rp1	Rp1
Sox17	Sox17
Mrpl15	Mrpl15
Lypla1	Lypla1
Tcea1	Tcea1
Rgs20	Rgs20
Atp6v1h	Atp6v1h
Oprk1	Oprk1
Npbwr1	Npbwr1
...
</pre>

<p>
The <code>barcodes.tsv</code> file contains the ids of each cell or observation and
corresponds to the columns of <code>matrix.mtx</code>.
</p>

<pre class="example">
AAACCTGCAGTAACGG-1
AAACGGGAGAAGAAGC-1
AAACGGGAGACCGGAT-1
AAACGGGAGCGCTCCA-1
AAACGGGAGGACGAAA-1
AAACGGGAGGTACTCT-1
AAACGGGAGGTGCTTT-1
AAACGGGAGTCGAGTG-1
AAACGGGCATGGTCAT-1
AAAGATGAGCTTCGCG-1
...
</pre>

<p>
For a <code>csv</code> file, the format is dense (observation columns (cells), feature rows
(genes)):
</p>

<pre class="example">
"","A22.D042044.3_9_M.1.1","C5.D042044.3_9_M.1.1","D10.D042044.3_9_M.1.1","E13.D042044.3_9_M.1.1","F19.D042044.3_9_M.1.1","H2.D042044.3_9_M.1.1","I9.D042044.3_9_M.1.1",...
"0610005C13Rik",0,0,0,0,0,0,0,...
"0610007C21Rik",0,112,185,54,0,96,42,...
"0610007L01Rik",0,0,0,0,0,153,170,...
"0610007N19Rik",0,0,0,0,0,0,0,...
"0610007P08Rik",0,0,0,0,0,19,0,...
"0610007P14Rik",0,58,0,0,255,60,0,...
"0610007P22Rik",0,0,0,0,0,65,0,...
"0610008F07Rik",0,0,0,0,0,0,0,...
"0610009B14Rik",0,0,0,0,0,0,0,...
...
</pre>

<p>
We also know where each cell came from, so we mark that down as well in a
<code>labels.csv</code> file.
</p>

<pre class="example">
item,label
AAACCTGCAGTAACGG-1,Marrow
AAACGGGAGACCGGAT-1,Marrow
AAACGGGAGCGCTCCA-1,Marrow
AAACGGGAGGACGAAA-1,Marrow
AAACGGGAGGTACTCT-1,Marrow
...
</pre>

<p>
This can be easily accomplished with <code>sed</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh">cat barcodes.tsv | sed <span style="color: #afaf00;">"s/-1/-1,Marrow/"</span> | s/-2/etc... &gt; labels.csv
</pre>
</div>

<p>
For <code>cellranger</code>, note that the <code>-1</code>, <code>-2</code>, etc. postfixes denote the first,
second, etc. label in the aggregation <code>csv</code> file used as input for <code>cellranger
aggr</code>.
</p>
</div>
</li>

<li><a id="org0971613"></a>Default run<br />
<div class="outline-text-5" id="text-org0971613">
<p>
We can now run the <code>too-many-cells</code> algorithm on our data. The resulting cells
with assigned clusters will be printed to <code>stdout</code> (don't forget to use
<code>--normalization NoneNorm</code> on preprocessed data, as stated <a href="#preprocessedData">here</a>). While older
versions had default filter thresholds for (MINCELL, MINFEATURE) counts, since
<code>v2.0.0.0</code> the default is now no filtering to account for multiple assay types.
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells make-tree <span style="color: #afaf00;">\</span>
    --matrix-path input <span style="color: #afaf00;">\</span>
    --labels-file labels.csv <span style="color: #afaf00;">\</span>
    --filter-thresholds <span style="color: #afaf00;">"(250, 1)"</span> <span style="color: #afaf00;">\</span>
    --draw-collection <span style="color: #afaf00;">"PieRing"</span> <span style="color: #afaf00;">\</span>
    --output out <span style="color: #afaf00;">\</span>
    &gt; clusters.csv
</pre>
</div>


<div class="figure">
<p><img src="img/complete_default_tree.png" alt="complete_default_tree.png" />
</p>
</div>
</div>
</li>

<li><a id="org46e119a"></a>Pruning tree<br />
<div class="outline-text-5" id="text-org46e119a">
<p>
Large cell populations can result in a very large tree. What if we only want to
see larger subpopulations rather than the large (inner nodes) and small
(leaves)? We can use the <code>--min-size 100</code> argument to set the minimum size of a
leaf to 100 in this case. Alternatively, we can specify <code>--smart-cutoff 4</code> in
addition to <code>--min-size 1</code> to set the minimum size of a node to \(4 *
\text{median absolute deviation (MAD)}\) of the nodes in the original tree.
Varying the number of MADs varies the number of leaves in the tree.
<code>--smart-cutoff</code> should be used in addition to <code>--min-size</code>, <code>--max-proportion</code>,
<code>--min-distance</code>, or <code>--min-distance-search</code> to decide which cutoff variable to
use. The value supplied to the cutoff variable is ignored when <code>--smart-cutoff</code>
is specified. We'll prune the tree for better visibility in this document.
</p>

<p>
<b>Note: the pruning arguments change the tree file, not just the plot, so be sure
to output into a different directory.</b>
</p>

<p>
Also, <b>we do not need to recalculate the entire tree!</b> We can just supply the
previous results using <code>--prior</code> (we can also remove <code>--matrix-path</code> with
<code>--prior</code> to speed things up, but miss out on some features if needed):
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells make-tree <span style="color: #afaf00;">\</span>
    --prior out <span style="color: #afaf00;">\</span>
    --labels-file labels.csv <span style="color: #afaf00;">\</span>
    --smart-cutoff <span style="color: #d787af;">4</span> <span style="color: #afaf00;">\</span>
    --min-size <span style="color: #d787af;">1</span> <span style="color: #afaf00;">\</span>
    --draw-collection <span style="color: #afaf00;">"PieRing"</span> <span style="color: #afaf00;">\</span>
    --output out_pruned <span style="color: #afaf00;">\</span>
    &gt; clusters_pruned.csv
</pre>
</div>


<div class="figure">
<p><img src="img/pruned_tree.png" alt="pruned_tree.png" />
</p>
</div>
</div>
</li>

<li><a id="org1d8f1b0"></a>Pie charts<br />
<div class="outline-text-5" id="text-org1d8f1b0">
<p>
What if we want pie charts instead of showing each individual cell (the
default)?
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells make-tree <span style="color: #afaf00;">\</span>
    --prior out <span style="color: #afaf00;">\</span>
    --labels-file labels.csv <span style="color: #afaf00;">\</span>
    --smart-cutoff <span style="color: #d787af;">4</span> <span style="color: #afaf00;">\</span>
    --min-size <span style="color: #d787af;">1</span> <span style="color: #afaf00;">\</span>
    --draw-collection <span style="color: #afaf00;">"PieChart"</span> <span style="color: #afaf00;">\</span>
    --output out_pruned <span style="color: #afaf00;">\</span>
    &gt; clusters_pruned.csv
</pre>
</div>


<div class="figure">
<p><img src="img/piechart_pruned_tree.png" alt="piechart_pruned_tree.png" />
</p>
</div>
</div>
</li>

<li><a id="org9747fba"></a>Node numbering<br />
<div class="outline-text-5" id="text-org9747fba">
<p>
Now that we see the relationships between clusters and nodes in the dendrogram,
how can we go back to the data &#x2013; which nodes represent which node IDs in the
data?
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells make-tree <span style="color: #afaf00;">\</span>
    --prior out <span style="color: #afaf00;">\</span>
    --labels-file labels.csv <span style="color: #afaf00;">\</span>
    --smart-cutoff <span style="color: #d787af;">4</span> <span style="color: #afaf00;">\</span>
    --min-size <span style="color: #d787af;">1</span> <span style="color: #afaf00;">\</span>
    --draw-collection <span style="color: #afaf00;">"PieChart"</span> <span style="color: #afaf00;">\</span>
    --draw-node-number <span style="color: #afaf00;">\</span>
    --output out_pruned <span style="color: #afaf00;">\</span>
    &gt; clusters_pruned.csv
</pre>
</div>


<div class="figure">
<p><img src="img/numbered_pruned_tree.png" alt="numbered_pruned_tree.png" />
</p>
</div>
</div>
</li>

<li><a id="orgd395f2d"></a>Branch width<br />
<div class="outline-text-5" id="text-orgd395f2d">
<p>
We can also change the width of the nodes and branches, for instance if we want
thinner branches:
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells make-tree <span style="color: #afaf00;">\</span>
    --prior out <span style="color: #afaf00;">\</span>
    --labels-file labels.csv <span style="color: #afaf00;">\</span>
    --smart-cutoff <span style="color: #d787af;">4</span> <span style="color: #afaf00;">\</span>
    --min-size <span style="color: #d787af;">1</span> <span style="color: #afaf00;">\</span>
    --draw-collection <span style="color: #afaf00;">"PieChart"</span> <span style="color: #afaf00;">\</span>
    --draw-max-node-size <span style="color: #d787af;">40</span> <span style="color: #afaf00;">\</span>
    --output out_pruned <span style="color: #afaf00;">\</span>
    &gt; clusters_pruned.csv
</pre>
</div>


<div class="figure">
<p><img src="img/thin_pruned_tree.png" alt="thin_pruned_tree.png" />
</p>
</div>
</div>
</li>

<li><a id="org23ac032"></a>No scaling<br />
<div class="outline-text-5" id="text-org23ac032">
<p>
We can remove all scaling for a normal tree and still control the branch widths:
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells make-tree <span style="color: #afaf00;">\</span>
    --prior out <span style="color: #afaf00;">\</span>
    --labels-file labels.csv <span style="color: #afaf00;">\</span>
    --smart-cutoff <span style="color: #d787af;">4</span> <span style="color: #afaf00;">\</span>
    --min-size <span style="color: #d787af;">1</span> <span style="color: #afaf00;">\</span>
    --draw-collection <span style="color: #afaf00;">"PieChart"</span> <span style="color: #afaf00;">\</span>
    --draw-max-node-size <span style="color: #d787af;">40</span> <span style="color: #afaf00;">\</span>
    --draw-no-scale-nodes <span style="color: #afaf00;">\</span>
    --output out_pruned <span style="color: #afaf00;">\</span>
    &gt; clusters_pruned.csv
</pre>
</div>


<div class="figure">
<p><img src="img/no_scaling_pruned_tree.png" alt="no_scaling_pruned_tree.png" />
</p>
</div>

<p>
How strong is each split? We can tell by drawing the modularity of the children
on top of each node:
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells make-tree <span style="color: #afaf00;">\</span>
    --prior out <span style="color: #afaf00;">\</span>
    --labels-file labels.csv <span style="color: #afaf00;">\</span>
    --smart-cutoff <span style="color: #d787af;">4</span> <span style="color: #afaf00;">\</span>
    --min-size <span style="color: #d787af;">1</span> <span style="color: #afaf00;">\</span>
    --draw-collection <span style="color: #afaf00;">"PieChart"</span> <span style="color: #afaf00;">\</span>
    --draw-mark <span style="color: #afaf00;">"MarkModularity"</span> <span style="color: #afaf00;">\</span>
    --output out_pruned <span style="color: #afaf00;">\</span>
    &gt; clusters_pruned.csv
</pre>
</div>


<div class="figure">
<p><img src="img/modularity_pruned_tree.png" alt="modularity_pruned_tree.png" />
</p>
</div>
</div>
</li>

<li><a id="orgc759c07"></a>Gene expression<br />
<div class="outline-text-5" id="text-orgc759c07">
<p>
What if we want to draw the gene expression onto the tree in another folder
(requires <code>--matrix-path</code>, may take some time depending on matrix size. Defaults
to all black if the feature name is not present in the matrix, so check the first
column of the feature file)? <b>Note</b>: the feature names are from the <code>genes.tsv</code> or
<code>features.tsv.gz</code> file. Usually, <code>cellranger</code> has Ensembl identifiers as the
first column and gene symbol as the second column, so if you want to specify
gene symbol, use <code>--feature-column 2</code> (1 is default).
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells make-tree <span style="color: #afaf00;">\</span>
    --prior out <span style="color: #afaf00;">\</span>
    --matrix-path input <span style="color: #afaf00;">\</span>
    --labels-file labels.csv <span style="color: #afaf00;">\</span>
    --filter-thresholds <span style="color: #afaf00;">"(250, 1)"</span> <span style="color: #afaf00;">\</span>
    --smart-cutoff <span style="color: #d787af;">4</span> <span style="color: #afaf00;">\</span>
    --min-size <span style="color: #d787af;">1</span> <span style="color: #afaf00;">\</span>
    --feature-column <span style="color: #d787af;">2</span> <span style="color: #afaf00;">\</span>
    --draw-leaf <span style="color: #afaf00;">"DrawItem (DrawContinuous [\"Cd4\"])"</span> <span style="color: #afaf00;">\</span>
    --output out_gene_expression <span style="color: #afaf00;">\</span>
    &gt; clusters_pruned.csv
</pre>
</div>


<div class="figure">
<p><img src="img/cd4_dendrogram.png" alt="cd4_dendrogram.png" />
</p>
</div>

<p>
Notice that <i>Cd4</i> is within a list ([]), so multiple features can be listed and
the average of those values for each cell will be used. While this
representation shows the expression of <i>Cd4</i> in each cell and blends those
levels together, due to the sparsity of single cell data these cells and their
respective subtrees may be hard to see without additional processing. Let's
scale the saturation to more clearly see sections of the tree with our desired
expression (when choosing other high and low colors with <code>--draw-colors</code>,
scaling the saturation will only affect non-grayscale colors).
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells make-tree <span style="color: #afaf00;">\</span>
    --prior out <span style="color: #afaf00;">\</span>
    --matrix-path input <span style="color: #afaf00;">\</span>
    --labels-file labels.csv <span style="color: #afaf00;">\</span>
    --filter-thresholds <span style="color: #afaf00;">"(250, 1)"</span> <span style="color: #afaf00;">\</span>
    --smart-cutoff <span style="color: #d787af;">4</span> <span style="color: #afaf00;">\</span>
    --min-size <span style="color: #d787af;">1</span> <span style="color: #afaf00;">\</span>
    --feature-column <span style="color: #d787af;">2</span> <span style="color: #afaf00;">\</span>
    --draw-leaf <span style="color: #afaf00;">"DrawItem (DrawContinuous [\"Cd4\"])"</span> <span style="color: #afaf00;">\</span>
    --draw-scale-saturation <span style="color: #d787af;">10</span>
    --output out_gene_expression <span style="color: #afaf00;">\</span>
    &gt; clusters_pruned.csv
</pre>
</div>


<div class="figure">
<p><img src="img/cd4_saturated_10_dendrogram.png" alt="cd4_saturated_10_dendrogram.png" />
</p>
</div>

<p>
There, much better! Now it's clearly enriched in the subtree containing the
thymus, where we would expect many T cells to be. While this tree makes the
expression a bit more visible, there is another tactic we can use. Instead of
the continuous color spectrum of expression values, we can have a binary "high"
and "low" expression. Here, we'll continue to have the red and gray colors
represent high and low expressions respectively using the <code>--draw-colors</code>
argument. Note that this binary expression technique can be used for multiple
features, hence it's a list of features with cutoffs (<code>Exact</code> for specified
cutoffs or <code>MadMedian</code> for how many MADs from the median) so you can be high in
a gene and low in another gene, etc. for all possible combinations.
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells make-tree <span style="color: #afaf00;">\</span>
    --prior out <span style="color: #afaf00;">\</span>
    --matrix-path input <span style="color: #afaf00;">\</span>
    --labels-file labels.csv <span style="color: #afaf00;">\</span>
    --filter-thresholds <span style="color: #afaf00;">"(250, 1)"</span> <span style="color: #afaf00;">\</span>
    --smart-cutoff <span style="color: #d787af;">4</span> <span style="color: #afaf00;">\</span>
    --min-size <span style="color: #d787af;">1</span> <span style="color: #afaf00;">\</span>
    --feature-column <span style="color: #d787af;">2</span> <span style="color: #afaf00;">\</span>
    --draw-leaf <span style="color: #afaf00;">"DrawItem (DrawThresholdContinuous [(\"Cd4\", Exact 0), (\"Cd8a\", Exact 0)])"</span> <span style="color: #afaf00;">\</span>
    --draw-colors <span style="color: #afaf00;">"[\"#e41a1c\", \"#377eb8\", \"#4daf4a\", \"#eaeaea\"]"</span> <span style="color: #afaf00;">\</span>
    --draw-scale-saturation <span style="color: #d787af;">10</span> <span style="color: #afaf00;">\</span>
    --output out_gene_expression <span style="color: #afaf00;">\</span>
    &gt; clusters_pruned.csv
</pre>
</div>


<div class="figure">
<p><img src="img/cd4_cd8_sat_10_dendrogram.png" alt="cd4_cd8_sat_10_dendrogram.png" />
</p>
</div>

<p>
Now we can see the expression of both <i>Cd4</i> and <i>Cd8a</i> at the same time!
</p>
</div>
</li>

<li><a id="org4db7aa9"></a>Diversity<br />
<div class="outline-text-5" id="text-org4db7aa9">
<p>
We can also see an overview of the diversity of cell labels within each subtree
and leaves.
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells make-tree <span style="color: #afaf00;">\</span>
    --prior out <span style="color: #afaf00;">\</span>
    --matrix-path input <span style="color: #afaf00;">\</span>
    --filter-thresholds <span style="color: #afaf00;">"(250, 1)"</span> <span style="color: #afaf00;">\</span>
    --labels-file labels.csv <span style="color: #afaf00;">\</span>
    --smart-cutoff <span style="color: #d787af;">4</span> <span style="color: #afaf00;">\</span>
    --min-size <span style="color: #d787af;">1</span> <span style="color: #afaf00;">\</span>
    --draw-leaf <span style="color: #afaf00;">"DrawItem DrawDiversity"</span> <span style="color: #afaf00;">\</span>
    --output out_diversity <span style="color: #afaf00;">\</span>
    &gt; clusters_pruned.csv
</pre>
</div>


<div class="figure">
<p><img src="img/diversity_pruned_tree.png" alt="diversity_pruned_tree.png" />
</p>
</div>

<p>
Here, the deeper the red, the more diverse (a larger "effective number of cell
states") the cell labels in that group are. Note that the inner nodes are
colored relative to themselves, while the leaves are colored relative to all
leaves, so there are two different scales.
</p>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-orga140db3" class="outline-3">
<h3 id="orga140db3"><code>interactive</code></h3>
<div class="outline-text-3" id="text-orga140db3">
<p>
The <code>interactive</code> entry point has a basic GUI interface for quick plotting with
a few features. We recommend limited use of this feature, however,
as it can be quite slow at this stage, has fewer customizations, and requires
specific dependencies.
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells interactive <span style="color: #afaf00;">\</span>
    --prior out <span style="color: #afaf00;">\</span>
    --labels-file labels.csv
</pre>
</div>
</div>
</div>

<div id="outline-container-org2d5e26d" class="outline-3">
<h3 id="org2d5e26d"><code>differential</code></h3>
<div class="outline-text-3" id="text-org2d5e26d">
<p>
A main use of single cell clustering is to find differential genes between
multiple groups of cells. The <code>differential</code> aids in this endeavor by allowing
comparisons with <code>edgeR</code>. Let's find the differential genes between the liver
group and all other cells. Consider our pruned tree from earlier:
</p>


<div class="figure">
<p><img src="img/piechart_pruned_tree.png" alt="piechart_pruned_tree.png" />
</p>
</div>

<p>
We can see the id of each group with <code>--draw-node-number</code>.
</p>


<div class="figure">
<p><img src="img/numbered_pruned_tree.png" alt="numbered_pruned_tree.png" />
</p>
</div>

<p>
We need to define two groups to compare. Well, it looks like node 98 defines the
liver cluster. Then, since we don't want 98 to be in the other group, we say
that all other cells are within nodes 89 and 1. As a result, we end up with a
tuple containing two lists: ([89, 1], [98]). Then our differential genes for
(liver / others) can be found with <code>differential</code> (sent to <code>stdout</code>):
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells differential <span style="color: #afaf00;">\</span>
    --matrix-path input <span style="color: #afaf00;">\</span>
    --filter-thresholds <span style="color: #afaf00;">"(250, 1)"</span> <span style="color: #afaf00;">\</span>
    -n <span style="color: #afaf00;">"([89, 1], [98])"</span> <span style="color: #afaf00;">\</span>
    &gt; differential.csv
</pre>
</div>

<p>
If we wanted to make the same comparison, but compare the liver subtree with
liver cells from all other subtrees, we can use the <code>--labels</code> argument:
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells differential <span style="color: #afaf00;">\</span>
    --matrix-path input <span style="color: #afaf00;">\</span>
    --labels-file labels.csv <span style="color: #afaf00;">\</span>
    --filter-thresholds <span style="color: #afaf00;">"(250, 1)"</span> <span style="color: #afaf00;">\</span>
    -n <span style="color: #afaf00;">"([89, 1], [98])"</span> <span style="color: #afaf00;">\</span>
    --labels <span style="color: #afaf00;">"([\"Liver\"], [\"Liver\"])"</span> <span style="color: #afaf00;">\</span>
    &gt; differential_liver.csv
</pre>
</div>

<p>
We can also look at the distribution of abundance for individual genes using the
<code>--features</code> and <code>--plot-output</code> arguments.
</p>

<p>
Furthermore, we can compare each node to all other cells by specifying no nodes
at all. The output file will contain the top <code>--top-n</code> genes for each node. We
recommend using multiple OS threads here to speed up the process using <code>+RTS
-N${NUMOSTHREADS}</code> (no number to use all cores). The following example will
compare all nodes to all other cells using 8 OS threads:
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells differential <span style="color: #afaf00;">\</span>
    --matrix-path input <span style="color: #afaf00;">\</span>
    --filter-thresholds <span style="color: #afaf00;">"(250, 1)"</span> <span style="color: #afaf00;">\</span>
    -n <span style="color: #afaf00;">"([], [])"</span> <span style="color: #afaf00;">\</span>
    --normalization <span style="color: #afaf00;">"UQNorm"</span> <span style="color: #afaf00;">\</span>
    +RTS -N8
</pre>
</div>
</div>
</div>

<div id="outline-container-org713068b" class="outline-3">
<h3 id="org713068b"><code>diversity</code></h3>
<div class="outline-text-3" id="text-org713068b">
<p>
Diversity is the measure of the "effective number of entities within a system",
originating from ecology (See Jost: Entropy and Diversity). Here, each cell is
an organism and each cell label or cluster is a species, depending on the
question. In ecology, the diversity index measures the effective number of
species within a population such that the minimum is a diversity of 1 for a
single dominant species up to maximum of the total number of species (evenly
abundant). If our species is a cluster, then here the diversity is the effective
number of cell states within a population (for labels, <code>make-tree</code> generates
these results automatically in "diversity" columns). Say we have two populations
and we generated the trees using <code>make-tree</code> into two different output folders,
<code>out1</code> and <code>out2</code>. We can find the diversity of each population using the
<code>diversity</code> entry point.
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells diversity<span style="color: #afaf00;">\</span>
    --priors out1 <span style="color: #afaf00;">\</span>
    --priors out2 <span style="color: #afaf00;">\</span>
    -o out_diversity_stats
</pre>
</div>

<p>
We can then find a simple plot of diversity in <code>diversity_output</code>. In addition,
we also provide rarefaction curves for comparing the number of different cell
states at each subsampling useful for comparing the number of cell states where
the population sizes differ.
</p>
</div>
</div>

<div id="outline-container-orgba6460a" class="outline-3">
<h3 id="orgba6460a"><code>paths</code></h3>
<div class="outline-text-3" id="text-orgba6460a">
<p>
"Pseudotime" refers to the one dimensional relationship between cells, useful
for looking at the ordering of cell states or labels. The implementation of
pseudotime in a <code>too-many-cells</code> point-of-view is by finding the distance
between all cells and the cells found in the longest path from the root in the
tree. Then each cell has a distance from the "start" and thus we plot those
distances.
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells paths<span style="color: #afaf00;">\</span>
    --prior out <span style="color: #afaf00;">\</span>
    --labels-file labels.csv <span style="color: #afaf00;">\</span>
    --bandwidth <span style="color: #d787af;">3</span> <span style="color: #afaf00;">\</span>
    -o out_paths
</pre>
</div>
</div>
</div>

<div id="outline-container-org001bec8" class="outline-3">
<h3 id="too-many-peaks">Working with scATAC-seq data using <code>too-many-peaks</code></h3>
<div class="outline-text-3" id="text-too-many-peaks">
<p>
scATAC-seq is a powerful technology for quantifying chromatin accessibility for
individual cells. <code>too-many-cells</code> now supports scATAC-seq to generate cell clade
relationships from chromatin state information through <code>too-many-peaks</code>. All of
the previous analyses used with gene-product features now work with genomic
regions in the form <code>chrN:START-END</code>, where <code>N</code> is the chromosome number,
<code>START</code> is the start of the region and <code>END</code> is the end base of the region.
</p>

<p>
Matrices in this format can be read from either <code>CSV</code> or <code>matrix-market</code> as
above but with the correctly formatted features, or you can load in directly
from a <code>fragments.tsv.gz</code> file in Cellranger format (tab delimited with each row
being <code>chrN\tSTART\tEND\tBARCODE\tCOUNT</code>) making sure that the filename contains
the fragments ending, such as <code>t-all_fragments.tsv.gz</code>. For example:
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells make-tree<span style="color: #afaf00;">\</span>
    -m ./t-all_fragments.tsv.gz <span style="color: #afaf00;">\</span>
    -Z <span style="color: #afaf00;">"T-ALL"</span> <span style="color: #afaf00;">\</span>
    -m ./control_fragments.tsv.gz
    -Z <span style="color: #afaf00;">"Control"</span> <span style="color: #afaf00;">\</span>
    --filter-thresholds <span style="color: #afaf00;">"(1000, 1)"</span> <span style="color: #afaf00;">\</span>
    --bindwidth <span style="color: #d787af;">5000</span> <span style="color: #afaf00;">\</span>
    --lsa <span style="color: #d787af;">50</span> <span style="color: #afaf00;">\</span>
    --normalization NoneNorm <span style="color: #afaf00;">\</span>
    --blacklist-regions-file Anshul_Hg19UltraHighSignalArtifactRegions.bed.gz <span style="color: #afaf00;">\</span>
    --draw-node-number <span style="color: #afaf00;">\</span>
    --draw-mark <span style="color: #afaf00;">"MarkModularity"</span> <span style="color: #afaf00;">\</span>
    --fragments-output <span style="color: #afaf00;">\</span>
    --labels-output <span style="color: #afaf00;">\</span>
    -o out <span style="color: #afaf00;">\</span>
    &gt; out_leaves.csv
</pre>
</div>

<p>
<b>Note</b>: We use <code>--lsa</code> and <code>--normalization NoneNorm</code> for latent semantic
analysis dimensionality reduction as there are many features in scATAC-seq, so
we try to overcome a potential issue where all cells are considered outliers. To
blacklist known biased regions in the genome, we can call
<code>--blacklist-regions-file</code>. The <code>--fragments-output</code> and <code>--labels-output</code> go
hand-in-hand with <code>-Z</code> in order to keep the renamed barcodes and labels (found
in the output folder). <code>too-many-cells</code> will binarize the data by default unless
<code>--no-binarize</code> is specified. Lastly, we choose a bindwidth using <code>--binwidth</code>
to conform to a set of standard features across cells and samples.
</p>
</div>
</div>

<div id="outline-container-org41d285d" class="outline-3">
<h3 id="org41d285d"><code>peaks</code></h3>
<div class="outline-text-3" id="text-org41d285d">
<p>
With scATAC-seq, we want to identify enriched locations in the genome for each
newly found subpopulation of cells. The <code>peaks</code> entrypoint can collect the
appropriate fragments for quantification and visualization of peaks.
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells peaks <span style="color: #afaf00;">\</span>
    -f ./out/fragments.tsv.gz <span style="color: #afaf00;">\</span>
    --prior ./out <span style="color: #afaf00;">\</span>
    --genome human.hg19.genome <span style="color: #afaf00;">\</span>
    --bedgraph <span style="color: #afaf00;">\</span>
    --labels-file ./out/labels.csv <span style="color: #afaf00;">\</span>
    --all-nodes <span style="color: #afaf00;">\</span>
    --peak-node <span style="color: #afaf00;">"1"</span> <span style="color: #afaf00;">\</span>
    --peak-node <span style="color: #afaf00;">"5"</span> <span style="color: #afaf00;">\</span>
    --peak-node-labels <span style="color: #afaf00;">"(1, [\"Control\"])"</span> <span style="color: #afaf00;">\</span>
    --peak-node-labels <span style="color: #afaf00;">"(5, [\"T-ALL\"])"</span> <span style="color: #afaf00;">\</span>
    -o out_peaks <span style="color: #afaf00;">\</span>
    +RTS -N6
</pre>
</div>

<p>
Here, we will have our peaks in the specified output folder, along with many
other files and folder:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">File</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>out_peaks/cluster_fragments</code></td>
<td class="org-left"><code>fragments.tsv.gz</code> files for each node.</td>
</tr>

<tr>
<td class="org-left"><code>out_peaks/cluster_bedgraphs</code></td>
<td class="org-left">Bedgraphs and bigwigs if specified using <code>--bedgraph</code> for track visualization uses.</td>
</tr>

<tr>
<td class="org-left"><code>out_peaks/cluster_peaks/union.bdg</code></td>
<td class="org-left">Merged peaks across all requested nodes in bedgraph format.</td>
</tr>

<tr>
<td class="org-left"><code>out_peaks/cluster_peaks/union_fragments.tsv.gz</code></td>
<td class="org-left">Merged peaks across all requested nodes in <code>fragments.tsv.gz</code> format.</td>
</tr>

<tr>
<td class="org-left"><code>out_peaks/cluster_peaks/</code></td>
<td class="org-left">Folder containing merged peaks across nodes and peaks for each individual node in each folder.</td>
</tr>
</tbody>
</table>

<p>
<code>--bedgraph</code> enabled the <code>cluster_bedgraphs</code> folder, while <code>--all-nodes</code>
specified to find peaks for all nodes, not just the leaves. However, when paired
with <code>--peak-node</code>, we just look at the peaks for each node in the list (but
<code>--all-nodes</code> is still required if looking at non-leaf nodes as well). Without
<code>--peak-node</code>, this command would have found peaks for every node. Furthermore,
<code>--peak-node-labels</code> allows the filtration based on the label of cells in of the
requested node. <code>--genome</code> tells the peak finding program where the genome file
is (containing the effective genome sizes of chromosomes in tab-delimited format
of <code>chrN\tSIZE</code> used in the MACS2 program). Here, the <code>-f</code> <code>fragments.tsv.gz</code>
and <code>labels.csv</code> was from the <a href="#too-many-peaks">previous scATAC-seq section</a>, where we
automatically generated the correctly renamed barcodes and labels. Lastly, <code>+RTS
-N6</code> tells <code>too-many-cells</code> to use six cores for the calculation. These output
files, especially the merged peak files, can be used for differential
accessibility analysis as in scRNA-seq. This entrypoint is highly customizable,
down to the exact command used for peak calling, so check out <code>too-many-cells
peaks -h</code> for more information.
</p>
</div>
</div>

<div id="outline-container-org2f4d597" class="outline-3">
<h3 id="org2f4d597"><code>motifs</code></h3>
<div class="outline-text-3" id="text-org2f4d597">
<p>
After differential accessibility using peaks, the result can be used to find
motifs enriched in each node.
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells motifs <span style="color: #afaf00;">\</span>
    --diff-file ./diff_out.csv <span style="color: #afaf00;">\</span>
    --motif-genome hg19.fa <span style="color: #afaf00;">\</span>
    --top-n <span style="color: #d787af;">1000</span> <span style="color: #afaf00;">\</span>
    --motif-command <span style="color: #afaf00;">"homer/homer-4.9/bin/findMotifs.pl %s fasta %s"</span> <span style="color: #afaf00;">\</span>
    -o motifs
</pre>
</div>

<p>
In this example, we use the output from a differential expression analysis using
<code>too-many-cells differential</code> from our merged peaks. Using a complete genome
file used by our motif program of choice (here homer, but defaults to MEME) with
<code>--motif-genome</code>, we want to provide the motif program with the top 1000 most
differential peaks using <code>--top-n</code>. Lastly, while the default uses MEME, we find
homer to be much faster. The prior command shows the use of another program to
find the motifs, making sure the <code>%s</code> for input and output are in the right
locations (check <code>too-many-cells motifs -h</code>).
</p>
</div>
</div>

<div id="outline-container-orgee26d3b" class="outline-3">
<h3 id="orgee26d3b"><code>classify</code></h3>
<div class="outline-text-3" id="text-orgee26d3b">
<p>
To identify potential cell type candidates from sorted bulk data,
<code>too-many-cells classify</code> uses cosine-similarity to provide scores for each bulk
population. For example, we have a scATAC-seq experiment in <code>./mat</code>. We also
have known bulk ATAC-seq peak data of B cells in bedgraph files. We can score
each cell with:
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells classify <span style="color: #afaf00;">\</span>
    --reference-file ./proB.bdg <span style="color: #afaf00;">\</span>
    --reference-file ./preB.bdg <span style="color: #afaf00;">\</span>
    --reference-file ./memoryB.bdg <span style="color: #afaf00;">\</span>
    --reference-file ./plasmaB.bdg <span style="color: #afaf00;">\</span>
    -m ./mat <span style="color: #afaf00;">\</span>
    --normalization <span style="color: #afaf00;">"NoneNorm"</span> <span style="color: #afaf00;">\</span>
    --blacklist-regions-file <span style="color: #afaf00;">"mm9-blacklist.bed.gz"</span> <span style="color: #afaf00;">\</span>
    &gt; labels.csv
</pre>
</div>

<p>
<code>--reference-file</code> is a list of bedgraphs here for each population. You can also
specify a single reference file as an input matrix with each barcode being the
label for the population, as bulk just has one sample. To use a single matrix,
use <code>--single-reference-matrix</code> in addition to <code>--reference-file</code> to specify the
file as a single reference matrix. The output will be identical to a normal
<code>too-many-cells</code> <code>labels.csv</code> file, but with an additional column <code>score</code> which
provides the value of the highest cosine-similarity label.
</p>
</div>
</div>

<div id="outline-container-org3465cbc" class="outline-3">
<h3 id="org3465cbc"><code>matrix-output</code></h3>
<div class="outline-text-3" id="text-org3465cbc">
<p>
A simple entrypoint to output the transformed matrix <code>too-many-cells</code> uses
before clustering. Saves to <code>--mat-output</code>.
</p>
</div>
</div>
</div>

<div id="outline-container-orged6ae7c" class="outline-2">
<h2 id="orged6ae7c">Advanced documentation</h2>
<div class="outline-text-2" id="text-orged6ae7c">
<p>
Each entry point has its own documentation accessible with <code>-h</code>, such as
<code>too-many-cells make-tree -h</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh">too-many-cells -h
</pre>
</div>

<pre class="example">
too-many-cells, Gregory W. Schwartz. Clusters and analyzes single cell data.

Usage: too-many-cells (make-tree | interactive | differential | diversity |
                      paths | classify | peaks | motifs | matrix-output)

Available options:
  -h,--help                Show this help text

Available commands:
  make-tree                
  interactive              
  differential             
  diversity                
  paths                    
  classify                 
  peaks                    
  motifs                   
  matrix-output            
</pre>
</div>
</div>

<div id="outline-container-org2038869" class="outline-2">
<h2 id="org2038869">Demo</h2>
<div class="outline-text-2" id="text-org2038869">
<p>
Check out an instructional example of using <code>too-many-cells</code> <a href="workshop/workshop.html">here</a> when finished
looking at the brief <a href="#makeTreeUsage">feature overview</a>.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Gregory W. Schwartz</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
